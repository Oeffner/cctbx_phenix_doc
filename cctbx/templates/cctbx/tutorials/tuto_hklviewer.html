{% extends "cctbx/header.html" %}

{% load static %}

{% block content %}

<div class="col-sm-9 main">
  <!-- DO NOT EDIT ANYTHING ABOVE!!!! -->
  <!----------------------- EDIT START ---------------------------->

  <h2><center>HKLViewer tutorial</center></h2>

  <p class="lead mt-4">This tutorial shows some use cases of the HKLviewer.</p>

  <!----------------------------------------------------------------------------->

  <h3 class="mt-4">Display I/SigI of a dataset</h3>

  <p>
    Reflections with I/SigI &gt; 2 are considered to be good data for structure solution. Therefore, this cutoff is
    often used to determine the resolution limit. Here we examine a problematic dataset to show that for a given threshold
    of I/SigI a matching resolution cutoff does not necessarily exist.<br>
    Load the file <a href="https://phenix-online.org/phenix_data/cctbx_phenix_doc_data/merged.mtz">merged.mtz</a> in the
    HKLviewer. On the Details tab the IMEAN,SIGIMEAN reflections are shown by double clicking that label in the
    upper left table of datasets.
  </p>

  <img style="max-width: 90%;" src="{% static 'cctbx/img/tutorials/tuto_hklviewer_01.png' %}">

  <p class="mt-3">
    By default, the colour mapping for each reflection is according to values of the intensity. The next
    section explains how to color according to I/sigI values.
  </p>

  <!----------------------------------------------------------------------------->

  <h3 class="mt-3">Computing I/SigI</h3>

  <p>
    Right click the row with the "IMEAN,SIGIMEAN" label and from the context menu select “Make a new dataset from
    this dataset and another dataset”.<br>
    In the “Create New Reflection data” dialog enter the lines of python code as given below into the textbox and “IoverSigI”
    as the formula and the label for the new data respectively.
  </p>

  <img style="max-width: 90%;" src="{% static 'cctbx/img/tutorials/tuto_hklviewer_02.png' %}">

  <p class="mt-3">
    The first statement <code>newarray._data = flex.abs(array1.data())/array1.sigmas()</code> computes the
    I/SigI of all data values but with the absolute values of the intensities since there appear to be a significant number
    of negative intensities.<br> 
    The <code>newarray</code> is always initialised to a copy of the original array (here representing "IMEAN,SIGIMEAN").<br>
    For I/SigI data we are not interested in the sigma values themselves. So we discard the sigmas array with the second
    statement <code>newarray._sigmas = None</code>.<br>
    The third statement <code>newarray.set_observation_type(None)</code> is optional. 
    It tells CCTBX to deduce which type of data newarray will contain. 
    In the case of I/SigI CCTBX will recognise the array as plain real numbers and the HKLviewer will then use a 
    default colour coding for that. It could have been more specialised types
    such as map coefficients or X-ray observations. Had we left out this statement <code>newarray</code> would still
    have the observation type of intensities and use the corresponding colour coding.

    Since the colour mapping and sizing schemes are specific to each observation
    type, datasets classified with sensible observation types makes it easier to compare datasets in the viewer with other
    datasets of the same observation type.<br>
    Clicking the "Compute new reflection dataset" button will execute the script and display the IoverSigI dataset in the viewer
    as below
  </p>

  <p class="mt-3">
    The "Binning" Tab lets you choose the number of bins and the thresholds. By default data is binned
    according to resolution.
    But here we have binned against the newly created “IoverSigI” column and set the number of bins to 7.<br>
    HKLviewer will try to put an equal number of reflections into each bin and then compute corresponding bin thresholds.
    But for this exercise,
    we want the bin thresholds at defined I/SigI values: -100, 0, 1, 2, 3, 4 and 1000.<br>
    Do this by entering these new bin thresholds by typing  the numbers 1000, 4, 3, 2, 1, 0, and -100 in
    row 7, 6, 5, 4, 3, 2 and 1 under the “lower bin value” column.<br>
    Then untick the "Opacity" checkboxes of the first three bins to hide reflections with I/SigI less than 2.
  </p>

  <img style="max-width: 100%;" src="{% static 'cctbx/img/tutorials/tuto_hklviewer_04.png' %}">

  <p class="mt-3">
    The first column of the "Binning" shows the number of reflections in each bin. The relatively small total
    number of reflections with I/SigI > 2 means that it will be difficult to solve the structure for this data set.
  </p>

  <!----------------------------------------------------------------------------->

  <h3 class="mt-3">Creating a custom button on the Quick View tab that displays I/SigI>=2 </h3>
  Here we describe how the I/SigI>=2 buttons on the Quick View tab has been created. This also
  demonstrates how a dataset created on the fly can be accomplished with a customised button.
  Having followed the sections above and assuming we have not changed any settings of the HKLviewer
  we can now make a general custom button that will always display I/SigI>=2 for any dataset containing I/SigI values.
  Do this by bringing up the Settings (or Preferences) dialog from the File menu and extract the PHIL parameters
  as described  <a href="../doc_hklviewer/#get_PHIL_params">here</a>. This should produce the following text:

<pre><code>
Current non-default phil parameters:

miller_array_operation = "('newarray._data = array1.data()/array1.sigmas()\\nnewarray._sigmas = None', 'IoverSigI', ['IMEAN,SIGIMEAN', 'Intensity'], ['', ''])"
binning {
  scene_bin_thresholds = -100 0 1 2 3 4 30.8 1000
  binlabel = 'IoverSigI'
  bin_opacity = 0 0
  bin_opacity = 0 1
  bin_opacity = 0 2
  bin_opacity = 1 3
  bin_opacity = 1 4
  bin_opacity = 1 5
  bin_opacity = 1 6
  bin_opacity = 1 7
  bin_opacity = 1 8
  nbins = 7
}
viewer {
  data_array {
    label = "IoverSigI"
    datatype = "Intensity"
  }
}
</code></pre>

  The PHIL parameters below the line "Current non-default phil parameters:" should then be copied into a tuple element in
the python list in the file,
  .hkl_viewer_buttons.py, that lives in the HOME directory as described <a href="../doc_hklviewer/#hkl_viewer_buttons_py_file">here</a>.
  The first two elements in the tuple should be a unique ID and an appropriate name such as "ISIGI2btn" and "I_SigI>=2",
  respectively. Next time the HKLviewer is started this button labelled "I_SigI>=2" will appear. This button will then
  be enabled for files containing datasets labelled 'IMEAN,SIGIMEAN' or, as a fallback, files with intensity datasets.


  <!----------------------------------------------------------------------------->

  <h3 class="mt-3">Inspecting TNCS modulation in a dataset</h3>

  <p>
    tNCS or pseudo-symmetry is a crystal pathology where two or more molecules in the unit cell are aligned in a way to
    cause interference in the diffraction pattern.
    It shows as periodic modulation of the diffraction pattern and can cause problems for structure solution unless
    identified and taken into
    account by the software. tNCS vectors are real space vectors and can be determined before structure solution attempts.
    The dataset <a href="https://files.rcsb.org/download/6C5F-sf.cif">6C5F</a> (available from the PDB) has tNCS which
    is detected by programs such as <code>Xtriage</code> and by <code>Xtricorder</code>.

  <h4 class="mt-3">Using Xtriage to illustrate TNCS</h4>

    Clicking the Xtriage button on the Quick View tab determined the pseudo-symmetry vector to be 
    [0.333, -0.334, 0.040] in fractional coordinates. Follow the steps below:
  </p>
  <ul>
    <li>Open the data file in the HKLviewer.</li>
    <li>Double click the "F_meas_au,F_meas_sigma_au" label (or "FP,SIGFP" if loading an mtz file) to display the data.</li>
    <li>On the Expansion tab, expand the reflections to a sphere.</li>
    <li>
      On the sizing tab, tick the “User defined power scaling” checkbox and enter a power factor of 2 to obtain values
      that are roughly proportional to intensities (the file from the PDB does not provide the original intensity data).
    </li>
    <li>
      On the Vectors tab Xtriage has entered the TNCS vector to the list of other vectors. It is labelled TNCS_xtriage.
    </li>
    <li>
      Tick the TNCS_xtriage vector checkbox as well as the “Orient vector” checkbox and the radio button “Parallel to
      screen”.
    </li>
    <li>Either rotate the reflections manually on the slider control or tick the “Rotate continuously” checkbox.</li>
  </ul>

  <p>
    This will show the modulations in the data as ripples in the reflections in planes perpendicular to the tNCS vector.
    It can be useful to tick the “Show Real Space Unit cell” checkbox to see where the tNCS vector points in relation to
  the unit cell.
  </p>

  <img style="max-width: 90%;" src="{% static 'cctbx/img/tutorials/tuto_hklviewer_05.png' %}">

  <h4 class="mt-3">Using Xtricorder to illustrate TNCS </h4>

  <p>
    
    Xtricorder stores a data column, TEPS, with the TNCS correction factors
    revealing the TNCS modulation of the intensities. The coordinates for the TNCS vector is embedded in the mtz
    file when the mtz file has been processed with phasertng and then listed on the vectors tab and as the
    buttons on the Quick View tab described <a href="../doc_hklviewer/#Xtricorder">here</a> named "Rotate around TNCS vector"
    and "Slice perpendicular to TNCS vector".
<br/>
    Pressing the button on the Quick View tab labelled "Rotate around TNCS vector" will then slice the reflections 
    with a clip plane width of around 8 units, expand all reflections to P1 and Friedel mates, align the reflections
    with the TNCS vector parallel to the screen, pointing upwards and rotate the sphere of reflections around the TNCS
    vector. This will show the TNCS madulation as coloured horizontal ripples in the sphere of reflections. 
<br/>
    We can also illustrate the modulation by pressing the "Slice perpendicular to TNCS vector" button. Thereby one can 
    inspect the modulation layer by layer. One would expect to see every other slice of reflections to have a 
    strong or weak TNCS correction factor. But this may sometimes be less obvious as the TNCS vector typically 
    is not completely parallel with a reciprocal space vector with 
    integer indices. Therefore a mixture of strong and weak reflections may be present in each slice.

  </p>

  <img style="max-width: 90%;" src="{% static 'cctbx/img/tutorials/tuto_hklviewer_06.png' %}">

<a name="inspecting_a_twin_law"></a>
  <h3 class="mt-4">Inspecting a twin law</h3>

  <p>
    The phenix tutorial with the file,
    <a href="https://phenix-online.org/phenix_data/cctbx_phenix_doc_data/porin.mtz">porin.mtz</a>, illustrates twinning.
    The twin operator found by phenix.xtriage is -h-k,k,-l.<br>
    Follow the steps below:
  </p>

  <ul>
    <li>Load the file in the HKLviewer and display the dataset “F-obs,SIGF-obs”.</li>
    <li>
      On the Vectors tab, enter the twin operator into the table of vectors; first by overwriting the last row with the
      “new vector” string with “twin”. Then by entering the string “-h-k,k,-l” in the adjacent rotation column and pressing
      return for the HKLviewer to accept the new twin operator. It turns out to be a 2-fold rotation so the HKLviewer will
      prefix the name with 2-fold.
    </li>
    <li>Press the “Orient vector” checkbox and the radio button “Normal to screen”.</li>
    <li>On the Expansion tab, expand the reflections to P1 and Friedel mates.</li>
    <li>
      On the Slicing tab, tick the “Slice with a clip plane” checkbox and set “Distance from Origin” and “Clip plane
      width” to 4 and 1 respectively.
    </li>
    <li>
      Show a “Tabulated Reflection data” window by right clicking the column label “F-obs,SIGF-obs” in the upper left
      table and selecting “Show a table…” from the menu.
    </li>
  </ul>

  <img style="max-width: 90%;" src="{% static 'cctbx/img/tutorials/tuto_hklviewer_07.png' %}">

  <p class="mt-3">
    To inspect data values of reflections related by the twin operator right-click a reflection in the view.
    It will bring up two tooltips with the hkl indices at the end of two vectors from the reciprocal space origin pointing to
    the twin reflections. Due to the clip plane, the vectors may not be fully visible. Double click one of the reflections
    to bring up the standard tooltip with all other values represented by this reflection (dres, F-obs, SIGF-obs, R-free-flags).
    Right-clicking a reflection will highlight the data value in the “Tabulated Reflection data” window. The HKL indices in the
    table are the original from file. Since the twin operator is not part of the spacegroup the hkl index in the tooltip of a
    twin related reflection may differ from the HKL index generated by P1 or Friedel mates expansion highlighted in the
    Tabulated Reflection Data.
  </p>

  <!----------------------- EDIT END ---------------------------->
  <!-- DO NOT EDIT ANYTHING BELOW!!!! -->
</div> <!-- end col-sm-9 -->

<!-- automatic table of contents
     located in the sidebar; will move to the top on a small screen -->
<div class="col-sm-3 mt-5">
  <nav id="toc" data-toggle="toc"></nav>
</div> <!-- end col-sm-3 -->


{% endblock %}
